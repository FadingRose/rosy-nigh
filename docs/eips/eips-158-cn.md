```
<!-- include: eip-158.md -->

---
eip: 158
title: 状态清理
author: Vitalik Buterin (@vbuterin)
type: 标准轨道
category: 核心
status: 最终
created: 2016-10-16
---

# 规范

对于所有 `block.number >= FORK_BLKNUM`（待定）的区块：
1. 在所有情况下，当对账户进行状态更改，并且此状态更改导致账户状态以 nonce = 0、balance = 0、code 为空、存储为空（以下简称“空账户”）保存时，该账户将被删除。
2. 如果一个地址被“触碰”且该地址包含一个空账户，则该账户将被删除。“触碰”定义为任何情况下，如果给定地址的账户不存在，它将被创建。
3. 每当 EVM 检查账户是否存在时，空账户被视为等同于不存在。特别注意，这意味着一旦启用此更改，从 EVM 执行的角度来看，空账户和不存在之间不再有有意义的区别。
4. 零值调用和零值自杀在任何情况下都不再消耗 25000 账户创建 gas 成本。

“触碰”发生的场景可以列举如下：
- 零值携带的 CALL 调用
- CREATE 操作（如果最终保存的代码为空且保存时账户中没有剩余以太币）
- 零值携带的 SUICIDE 操作
- 交易接收者
- 合约创建交易中创建的合约
- 矿工接收交易费用（注意 gasprice 为零的情况，以及账户尚未存在的情况，因为它只在处理完所有交易后接收区块/叔块/侄块奖励）
### 规范 (1b)

当 EVM 检查空账户（可能应用 25000 gas 成本）时，空账户定义为 `is_empty(acct): return get_balance(acct) == 0 and get_code(acct) == "" and get_nonce(acct) == 0`；存储的空不重要。这简化了客户端实现，因为不需要增加额外的复杂性以正确方式使缓存可枚举，并且不会显著影响预期结果，因为在 balance/code/nonce 为空但存储非空的场景中，此更改会导致额外支付 25000 gas 的情况是病态的，没有实际使用价值。
### 规范 (1c)

不要实现上述第 2 点（即不能创建新的空账户，但现有空账户不会自动销毁，除非它们的状态实际上发生了变化）。相反，从 N 开始（包括 N），直到没有空账户为止，每次区块选择按 sha3(address) 顺序排列的最左侧的 1000 个空账户，并删除它们（按哈希排序是必要的，以便可以通过迭代树轻松找到账户）。
# 基本原理

这移除了由于早期以太坊协议版本中的缺陷而以极低成本放入状态的大量空账户，从而大大减少了状态大小，进而减少了全节点的硬盘负载并减少了快速同步的时间。此外，它简化了协议的长期发展，因为一旦所有“空”对象被清除，账户空和不存在之间不再有有意义的区别，实际上可以将不存在视为空的一种紧凑表示。

请注意，此提案确实引入了**临时**的现有保证破坏，即通过重复零值调用已存在的空账户，可以在每个账户 700 gas 的成本下创建状态更改，而不是通常的每 gas 最低 5000 gas（通过 SUICIDE 退款，这进一步降至每个账户 350 gas）。允许每区块进行如此大量的状态写入将导致区块处理时间增加，并在短期内增加叔块率，而当所有空账户被清除后，此问题将不再存在。

# 参考文献

1. EIP-158 问题和讨论：https://github.com/ethereum/EIPs/issues/158
2. EIP-161 问题和讨论：https://github.com/ethereum/EIPs/issues/161
```
